prefix: ep
source: https://github.com/entigolabs/entigo-infralib-release
version: stable
steps:
  - name: network
    type: terraform
    workspace: test
    approve: minor
    modules:
      - name: vpc
        source: aws/vpc
        version: stable
        inputs:
          vpc_cidr: "10.175.0.0/16"
          one_nat_gateway_per_az: true
          private_subnets: |
            ["10.175.32.0/21", "10.175.40.0/21", "10.175.48.0/21"]
          public_subnets: |
            ["10.175.4.0/24", "10.175.5.0/24", "10.175.6.0/24"]
          database_subnets: |
            ["10.175.16.0/22", "10.175.20.0/22", "10.175.24.0/22"]
          elasticache_subnets: |
            ["10.175.0.0/26", "10.175.0.64/26", "10.175.0.128/26"]
          intra_subnets: |
            []
      - name: dns
        source: aws/route53
        version: stable
        depends_on:
        - vpc
        inputs:
          vpc_prefix: "ep-network-vpc"
          parent_zone_id: "Z07983041XRLSLZUTHHDY"
  - name: infrastructure
    type: terraform
    workspace: test
    version: stable
    vpc_prefix: ep-network-vpc
    approve: minor
    modules:
      - name: eks
        source: aws/eks
        version: stable
        inputs:
          vpc_prefix: "ep-network-vpc"
          eks_main_min_size: 3
          eks_main_max_size: 6
          eks_spot_max_size: 0
          eks_db_max_size: 0
          cluster_enabled_log_types: |
            []
      - name: helm
        source: aws/helm
        version: stable
        depends_on:
        - eks
        inputs:
          chart: "k8s/argocd"
          version: "stable"
            
  - name: applications
    type: argocd-apps
    workspace: test
    version: stable
    vpc_prefix: ep-network-vpc
    modules:
      - name: aws-alb
        source: k8s/aws-alb
        version: stable
      - name: crossplane
        source: k8s/crossplane
        version: stable
      - name: external-dns
        source: k8s/external-dns
        version: stable
      - name: istio-base
        source: k8s/istio-base
        version: stable
      - name: istio-istiod
        source: k8s/istio-istiod
        version: stable
        inputs:
          domain: "*.ep-test.infralib.entigo.io"
          altdomain:
            - "*.something.ep-test.infralib.entigo.io"
