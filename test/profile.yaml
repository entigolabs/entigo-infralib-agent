source: https://github.com/entigolabs/entigo-infralib-release
base_config:
  profile: minimal
prefix: at
version: stable
agent_version: latest
steps:
  - name: network
    type: terraform
    workspace: test
    provider:
      aws:
        default_tags:
          tags:
            team: networking
        ignore_tags:
          key_prefixes:
          - ignoreme
          keys:
          - ignoremetoo
    approve: minor
    modules:
      - name: main
        source: aws/vpc
        version: stable
        inputs:
          vpc_cidr: "10.105.0.0/16"
          one_nat_gateway_per_az: false
          enable_nat_gateway: false
          azs: 1
          intra_subnets: |
            []
          elasticache_subnets: |
            []
          database_subnets: |
            []

  - name: infra
    type: terraform
    workspace: test
    provider:
      aws:
        default_tags:
          tags:
            team: infrastructure
    version: stable
    vpc_id: "{{ .ssm.network.main.vpc_id }}"
    vpc_subnet_ids: |
      [{{ .ssm.network.main.private_subnets }}]
    vpc_security_group_ids: |
      [{{ .ssm.network.main.pipeline_security_group }}]
    approve: minor
    modules:
      - name: dns
        source: aws/route53
        version: stable
        inputs:
          parent_zone_id: "Z07983041XRLSLZUTHHDY"
          public_subdomain_name: "agenttest"
          create_private: false
          create_public: false
          create_cert: false
  - name: applications
    type: argocd-apps
    workspace: test
    version: stable
    vpc_id: "{{ .ssm.network.main.vpc_id }}"
    vpc_subnet_ids: |
      [{{ .ssm.network.main.private_subnets }}]
    vpc_security_group_ids: |
      [{{ .ssm.network.main.pipeline_security_group }}]
    repo_url: "test_repo_url"
    modules:
      - name: external-dns
        source: external-dns
        version: stable
        inputs:
          stepvalue: "{{ ssm.infra.dns.int_domain }}"
          configvalue: "{{ .config.prefix }}"
  - name: additional
    type: terraform-custom
    workspace: test
    approve: never
